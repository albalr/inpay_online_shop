<!DOCTYPE html>
<html>
<head>
  <title>Inpay Online Shop</title>
  <meta name="csrf-token" content="<%= form_authenticity_token %>">
  <style>
      body {
          font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
          background-color: #0C2228;
          color: #ffffff;
          margin: 0;
          padding: 4rem 2rem 2rem;
      }

      h1 {
          font-size: 2.5rem;
          margin-bottom: 1.5rem;
      }

      table {
          width: 100%;
          border-collapse: collapse;
          background: #122e35;
          border-radius: 10px;
          margin-bottom: 2rem;
      }

      th, td {
          padding: 1rem;
          text-align: left;
          border-bottom: 1px solid #1f3a41;
      }

      th {
          background-color: #122e35;
          color: #3DF68F;
          font-weight: 600;
      }

      input[type="number"] {
          width: 60px;
          padding: 0.3rem;
          border: 1px solid #3DF68F;
          border-radius: 4px;
          background-color: #0C2228;
          color: #fff;
      }

      .admin-button, .submit-button, .add-button, .remove-button {
          background-color: transparent;
          border: 2px solid #3DF68F;
          color: #3DF68F;
          padding: 0.5rem 1rem;
          border-radius: 20px;
          cursor: pointer;
          font-weight: bold;
          text-decoration: none;
          transition: all 0.3s;
      }

      .admin-button:hover, .submit-button:hover, .add-button:hover, .remove-button:hover {
          background-color: #3DF68F;
          color: #0C2228;
      }

      .cart-preview {
          background: #122e35;
          border-radius: 10px;
          padding: 1rem;
          margin-top: 2rem;
      }

      .cart-preview h2 {
          color: #3DF68F;
      }
  </style>
</head>

<body>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
  <h1 style="margin: 0;">Inpay Online Shop</h1>

  <% if params[:admin] == "true" %>
    <div>
      <%= link_to "Exit Admin", url_for(params.permit!.to_h.except("admin")), class: "admin-button" %>
      <%= link_to "Create Product", new_product_path, class: "admin-button", style: "margin-left: 10px;" %>
    </div>
  <% else %>
    <%= link_to "Admin Access", url_for(params.permit!.to_h.merge(admin: "true")), class: "admin-button" %>
  <% end %>
</div>

<table>
  <thead>
  <tr>
    <th>Product</th>
    <th>Description</th>
    <th>Price</th>
    <th>Stock</th>
    <th>Quantity</th>
    <th></th>
    <% if params[:admin] == "true" %>
      <th></th>
    <% end %>
  </tr>
  </thead>
  <tbody>
  <% @products.each do |product| %>
    <tr>
      <td><%= product.name %></td>
      <td><%= product.description %></td>
      <td>DKK <%= product.price %></td>
      <td><%= product.stock_quantity %></td>
      <td><input type="number" id="qty_<%= product.id %>" min="1" max="<%= product.stock_quantity %>" value="1"></td>
      <td><button class="add-button" onclick="addToCart(<%= product.id %>, '<%= j product.name %>')">Add to Cart</button></td>
      <% if params[:admin] == "true" %>
        <td>
          <%= button_to "Remove", product_path(product), method: :delete, data: { confirm: "Are you sure?" }, class: "remove-button", form: { style: "display:inline;" } %>
        </td>
      <% end %>
    </tr>
  <% end %>
  </tbody>
</table>

<div class="cart-preview" id="cart">
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
    <tr>
      <th colspan="5" style="text-align: left; font-size: 1.5rem; color: #3DF68F; padding: 1rem;">Cart</th>
    </tr>
    <tr>
      <th style="color:#3DF68F;">Product</th>
      <th style="color:#3DF68F;">Price</th>
      <th style="color:#3DF68F;">Quantity</th>
      <th style="color:#3DF68F;">Subtotal</th>
      <th></th>
    </tr>
    </thead>
    <tbody id="cart-items"></tbody>
  </table>
  <div style="text-align: right; margin-top: 1rem;">
    <button class="submit-button" onclick="submitCart()">Place Order</button>
  </div>
</div>

<script>
    let cart = [];

    function addToCart(productId, productName) {
        const quantityInput = document.getElementById(`qty_${productId}`);
        const quantity = parseInt(quantityInput.value);
        const priceCell = quantityInput.closest("tr").querySelector("td:nth-child(3)");
        const price = parseFloat(priceCell.textContent.replace("DKK", "").trim());

        if (!quantity || quantity <= 0) return;

        const existing = cart.find(item => item.product_id === productId);
        if (existing) {
            existing.quantity += quantity;
        } else {
            cart.push({ product_id: productId, quantity, name: productName, price });
        }

        renderCart();
        quantityInput.value = 1;
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.product_id !== productId);
        renderCart();
    }

    function renderCart() {
        const list = document.getElementById("cart-items");
        list.innerHTML = "";
        let total = 0;

        cart.forEach(item => {
            const subtotal = item.price * item.quantity;
            total += subtotal;

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${item.name}</td>
              <td>DKK ${item.price.toFixed(2)}</td>
              <td>${item.quantity}</td>
              <td>DKK ${subtotal.toFixed(2)}</td>
              <td><button class="remove-button" onclick="removeFromCart(${item.product_id})">Remove</button></td>
            `;
            list.appendChild(row);
        });

        if (cart.length > 0) {
            const totalRow = document.createElement("tr");
            totalRow.innerHTML = `
              <td colspan="3" style="text-align: right; font-weight: bold; padding-top: 1rem;">Total:</td>
              <td style="font-weight: bold; padding-top: 1rem;">DKK ${total.toFixed(2)}</td>
              <td></td>
            `;
            list.appendChild(totalRow);
        }
    }

    function submitCart() {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/orders";

        const csrf = document.querySelector("meta[name='csrf-token']");
        if (csrf) {
            const token = document.createElement("input");
            token.type = "hidden";
            token.name = "authenticity_token";
            token.value = csrf.content;
            form.appendChild(token);
        }

        cart.forEach(item => {
            const pid = document.createElement("input");
            pid.type = "hidden";
            pid.name = "items[][product_id]";
            pid.value = item.product_id;

            const qty = document.createElement("input");
            qty.type = "hidden";
            qty.name = "items[][quantity]";
            qty.value = item.quantity;

            form.appendChild(pid);
            form.appendChild(qty);
        });

        document.body.appendChild(form);
        form.submit();
    }
</script>
</body>
</html>
